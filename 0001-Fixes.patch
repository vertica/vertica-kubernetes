From 4d0a9a1a82d93b241810446bf0b19eb9d9793f2b Mon Sep 17 00:00:00 2001
From: Matt Spilchen <matt.spilchen@vertica.com>
Date: Fri, 7 Apr 2023 10:15:14 -0300
Subject: [PATCH] Fixes

---
 cmd/operator/main.go                          |  2 +-
 pkg/opcfg/config.go                           |  7 ++++++
 scripts/template-helm-chart.sh                | 24 +++++++++++++------
 .../e2e-leg-3/metrics-disabled/05-assert.yaml |  1 +
 .../e2e-leg-3/metrics-no-auth/05-assert.yaml  |  1 +
 .../prometheus-service-monitor/10-assert.yaml |  1 +
 .../prometheus-service-monitor/20-assert.yaml |  1 +
 7 files changed, 29 insertions(+), 8 deletions(-)

diff --git a/cmd/operator/main.go b/cmd/operator/main.go
index 03e35ac..cd2fef3 100644
--- a/cmd/operator/main.go
+++ b/cmd/operator/main.go
@@ -162,7 +162,7 @@ func setupWebhook(ctx context.Context, mgr manager.Manager, restCfg *rest.Config
 			if err := security.GenerateWebhookCert(ctx, &setupLog, restCfg, CertDir, oc.PrefixName, watchNamespace); err != nil {
 				return err
 			}
-		} else {
+		} else if !oc.SkipWebhookPatch {
 			if err := security.PatchWebhookCABundleFromSecret(ctx, &setupLog, restCfg, oc.WebhookCertSecret,
 				oc.PrefixName, watchNamespace); err != nil {
 				return err
diff --git a/pkg/opcfg/config.go b/pkg/opcfg/config.go
index 071301f..766e3a4 100644
--- a/pkg/opcfg/config.go
+++ b/pkg/opcfg/config.go
@@ -46,6 +46,11 @@ type OperatorConfig struct {
 	PrefixName           string // Prefix of the name of all objects created when the operator was deployed
 	WebhookCertSecret    string // when this is empty we will generate the webhook cert
 	DevMode              bool
+	// If the webhook is enabled but we don't require a webhook config patch.
+	// This should be true only if the webhook CA bundle was provided during
+	// deployment or using cert-manager, which handles the CA bundle injection
+	// itself.
+	SkipWebhookPatch bool
 	Logging
 }
 
@@ -75,6 +80,8 @@ func (o *OperatorConfig) SetFlagArgs() {
 	flag.StringVar(&o.WebhookCertSecret, "webhook-cert-secret", "",
 		"Specifies the secret that contains the webhook cert. If this option is omitted, "+
 			"then the operator will generate the certificate.")
+	flag.BoolVar(&o.SkipWebhookPatch, "skip-webhook-patch", false,
+		"If the operator should skip updating the CA bundle in the webhook config")
 	flag.BoolVar(&o.DevMode, "dev", DefaultDevMode,
 		"Enables development mode if true and production mode otherwise.")
 	flag.StringVar(&o.FilePath, "filepath", "",
diff --git a/scripts/template-helm-chart.sh b/scripts/template-helm-chart.sh
index 4ad872a..b620085 100755
--- a/scripts/template-helm-chart.sh
+++ b/scripts/template-helm-chart.sh
@@ -134,12 +134,20 @@ do
 done
 
 # 10.  Template the webhook access enablement
-sed -i '1s/^/{{- if .Values.webhook.enable -}}\n/' $TEMPLATE_DIR/verticadb-operator-validating-webhook-configuration-validatingwebhookconfiguration.yaml 
-echo "{{- end }}" >> $TEMPLATE_DIR/verticadb-operator-validating-webhook-configuration-validatingwebhookconfiguration.yaml
-sed -i '1s/^/{{- if .Values.webhook.enable -}}\n/' $TEMPLATE_DIR/verticadb-operator-mutating-webhook-configuration-mutatingwebhookconfiguration.yaml
-echo "{{- end }}" >> $TEMPLATE_DIR/verticadb-operator-mutating-webhook-configuration-mutatingwebhookconfiguration.yaml
+for f in $TEMPLATE_DIR/verticadb-operator-validating-webhook-configuration-validatingwebhookconfiguration.yaml \
+    $TEMPLATE_DIR/verticadb-operator-mutating-webhook-configuration-mutatingwebhookconfiguration.yaml
+do
+    sed -i '1s/^/{{- if .Values.webhook.enable -}}\n/' $f
+    echo "{{- end }}" >> $f
+    perl -i -0777 -pe 's/(  annotations:)/$1\n{{- if eq .Values.webhook.certSource "cert-manager" }}/' $f
+    perl -i -0777 -pe 's/(    cert-manager.io.*)/$1\n{{- else }}\n    \{\}\n{{- end }}/' $f
+done
 sed -i '1s/^/{{- if .Values.webhook.enable -}}\n/' $TEMPLATE_DIR/verticadb-operator-webhook-service-svc.yaml
 echo "{{- end }}" >> $TEMPLATE_DIR/verticadb-operator-webhook-service-svc.yaml
+# Related to this change is the --skip-webhook-patch option. This is needed if
+# the helm chart provided the CA bundle or using cert-manager, which handles
+# the CA bundle update itself.
+perl -i -0777 -pe 's/(--webhook-cert-secret.*)/$1\n{{- if or (eq .Values.webhook.certSource "cert-manager") (.Values.webhook.caBundle) }}\n        - --skip-webhook-patch\n{{- end }}/g' $TEMPLATE_DIR/verticadb-operator-controller-manager-deployment.yaml
 
 # 11.  Template the prometheus metrics service
 sed -i '1s/^/{{- if hasPrefix "Enable" .Values.prometheus.expose -}}\n/' $TEMPLATE_DIR/verticadb-operator-metrics-service-svc.yaml
@@ -204,11 +212,13 @@ cat << EOF >> $TEMPLATE_DIR/verticadb-operator-controller-manager-deployment.yam
 EOF
 
 # 19. There are clusterrole/clusterrolebinding that are only needed if the
-# operator is generating its own self-signed cert for webhook. Skip those to
-# allow for deployments where you don't have cluster admin privileges.
+# operator is going to patch the webhook. This is needed only if the operator
+# is generating its own self-signed cert for the webhook or a secret was
+# provided. For cert-manager, the cert-manager operator injects the CA and the
+# operator doesn't need to handle that.
 for f in verticadb-operator-manager-role-cr.yaml \
     verticadb-operator-manager-clusterrolebinding-crb.yaml
 do
-    sed -i '1s/^/{{- if and (eq .Values.webhook.certSource "internal") (.Values.webhook.enable) -}}\n/' $TEMPLATE_DIR/$f
+    sed -i '1s/^/{{- if and (.Values.webhook.enable) (or (eq .Values.webhook.certSource "internal") (.Values.webhook.tlsSecret)) -}}\n/' $TEMPLATE_DIR/$f
     echo "{{- end }}" >> $TEMPLATE_DIR/$f
 done
diff --git a/tests/e2e-leg-3/metrics-disabled/05-assert.yaml b/tests/e2e-leg-3/metrics-disabled/05-assert.yaml
index b080e6b..5573d03 100644
--- a/tests/e2e-leg-3/metrics-disabled/05-assert.yaml
+++ b/tests/e2e-leg-3/metrics-disabled/05-assert.yaml
@@ -31,6 +31,7 @@ spec:
     - --dev=false
     - --prefix-name=verticadb-operator
     - --webhook-cert-secret=verticadb-operator-controller-manager-service-cert
+    - --skip-webhook-patch
 status:
   phase: Running
 ---
diff --git a/tests/e2e-leg-3/metrics-no-auth/05-assert.yaml b/tests/e2e-leg-3/metrics-no-auth/05-assert.yaml
index 24b451a..d814a73 100644
--- a/tests/e2e-leg-3/metrics-no-auth/05-assert.yaml
+++ b/tests/e2e-leg-3/metrics-no-auth/05-assert.yaml
@@ -32,6 +32,7 @@ spec:
     - --dev=true
     - --prefix-name=verticadb-operator
     - --webhook-cert-secret=verticadb-operator-controller-manager-service-cert
+    - --skip-webhook-patch
 status:
   phase: Running
 ---
diff --git a/tests/e2e-leg-3/prometheus-service-monitor/10-assert.yaml b/tests/e2e-leg-3/prometheus-service-monitor/10-assert.yaml
index 9254606..7a556d0 100644
--- a/tests/e2e-leg-3/prometheus-service-monitor/10-assert.yaml
+++ b/tests/e2e-leg-3/prometheus-service-monitor/10-assert.yaml
@@ -32,6 +32,7 @@ spec:
     - --dev=false
     - --prefix-name=verticadb-operator
     - --webhook-cert-secret=verticadb-operator-controller-manager-service-cert
+    - --skip-webhook-patch
   - name: kube-rbac-proxy
 status:
   phase: Running
diff --git a/tests/e2e-leg-3/prometheus-service-monitor/20-assert.yaml b/tests/e2e-leg-3/prometheus-service-monitor/20-assert.yaml
index c018f15..75dbddc 100644
--- a/tests/e2e-leg-3/prometheus-service-monitor/20-assert.yaml
+++ b/tests/e2e-leg-3/prometheus-service-monitor/20-assert.yaml
@@ -32,6 +32,7 @@ spec:
     - --dev=false
     - --prefix-name=verticadb-operator
     - --webhook-cert-secret=verticadb-operator-controller-manager-service-cert
+    - --skip-webhook-patch
 status:
   phase: Running
 ---
-- 
2.34.1

