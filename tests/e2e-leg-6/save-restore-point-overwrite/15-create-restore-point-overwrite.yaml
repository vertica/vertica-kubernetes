# (c) Copyright [2021-2024] Open Text.
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |
      id=$(kubectl exec -n $NAMESPACE v-restore-point-sc1-0 -- vsql -w superuser -tAc "select id from archive_restore_points where archive_name='test')
      INDEX=$(kubectl get vdb v-restore-point -n $NAMESPACE -o json | jq '.status.conditions | map(.type == "SaveRestorePointNeeded") | index(true)')
      && kubectl patch vdb v-restore-point -n $NAMESPACE --type='json' -p="[{'op': 'replace', 'path': '/status/conditions/$INDEX/status', 'value': 'True'}]" --subresource='status'
      && kubectl wait --for=condition=SaveRestorePointNeeded=True vdb/v-restore-point -n $NAMESPACE --timeout=600s
      new_count=$(kubectl exec -n $NAMESPACE v-restore-point-sc1-0 -- vsql -w superuser -tAc "select count(id) from archive_restore_points where archive_name='test')
      new_id=$(kubectl exec -n $NAMESPACE v-restore-point-sc1-0 -- vsql -w superuser -tAc "select id from archive_restore_points where archive_name='test')
      if [ $new_count -gt 1 ]; then
        echo "Assertion failed: expected 1 restore point, got $new_count"
        exit 1
      fi
      new_id=$(kubectl exec -n $NAMESPACE v-restore-point-sc1-0 -- vsql -w superuser -tAc "select id from archive_restore_points where archive_name='test')
      if [ $new_id == $id ]; then
        echo "Assertion failed: expected new restore point id, got existing one"
        exit 1
      fi