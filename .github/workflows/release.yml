name: Release Operator

on: 
  workflow_dispatch:
    inputs:
      action:
        description: 'What release actions to run?'
        required: true
        type: choice
        options:
        - all
        - upload operator image
        - create github release
        - add helm chart
        - upload bundle for operatorhub OLM catalog
        - upload bundle for openshift OLM catalog
    secrets:
      DOCKERHUB_USERNAME:
        description: 'When working with images from docker.io, this is the username for login purposes'
        required: true
      DOCKERHUB_TOKEN:
        description: 'When working with images from docker.io, this is the password for login purposes'
        required: true
      PAT_TOKEN:
        description: Personal access token to GitHub. Access to repos other than this one.
        required: true

run-name: "Release Action: ${{ inputs.action }}"

jobs:

  release-setup:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      version-sha: ${{ steps.version-sha.outputs.VERSION_SHA }}
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get the operator version
      id: version
      shell: bash
      run: |
        echo $(make echo-versions | grep -e '^VERSION=' ) >> $GITHUB_OUTPUT
        echo $(make echo-versions | grep -e '^VERSION=' ) >> $GITHUB_ENV

    - name: Get the commit reference of the operator version
      id: version-sha
      shell: bash
      run: |
        cd $GITHUB_WORKSPACE/${{ inputs.path }}
        git tag --list
        echo "VERSION_SHA=$(git rev-list -n 1 $VERSION)" >> $GITHUB_OUTPUT

    - name: Download the release artifacts
      run: |
        scripts/download-release-artifacts.sh -d ci-artifacts $VERSION
        find ci-artifacts
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Upload bundle to use later in the workflow
      uses: actions/upload-artifact@v3
      with:
        name: olm-bundle
        path: ci-artifacts/${{ steps.version.outputs.VERSION }}/olm-bundle/


  upload-operator-image:
    if: ${{ inputs.action == 'upload operator image' || inputs.action == 'all' }}
    runs-on: ubuntu-22.04
    needs: release-setup
    env:
      BUILD_IMG: ghcr.io/vertica/verticadb-operator
      PUBLIC_IMG: vertica/verticadb-operator
    steps:
    - uses: actions/checkout@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Upload new image
      run: |
        docker pull $BUILD_IMG:${{ needs.release-setup.outputs.version-sha }}
        for tag in ${{ needs.release-setup.outputs.version }} latest
        do
          docker tag $BUILD_IMG:${{ needs.release-setup.outputs.version-sha }} $PUBLIC_IMG:$tag
          docker push $PUBLIC_IMG:$tag
        done


  create-github-release:
    if: ${{ inputs.action == 'create github release' || inputs.action == 'all' }}
    runs-on: ubuntu-22.04
    needs: release-setup
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Create the release 
      run: |
        scripts/download-release-artifacts.sh -d ci-artifacts ${{ needs.release-setup.outputs.version }}
        scripts/create-release.sh -d ci-artifacts ${{ needs.release-setup.outputs.version }}
      env:
        GH_TOKEN: ${{ github.token }}


  add-helm-chart:
    if: ${{ inputs.action == 'update helm chart' || inputs.action == 'all' }}
    runs-on: ubuntu-22.04
    needs: release-setup
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Start workflow to add the helm chart for the operator release
      run: |
        curl \
        -X POST \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
        --fail \
        https://api.github.com/repos/vertica/charts/actions/workflows/add-verticadb-chart.yaml/dispatches  \
        -d '{"ref":"main",
             "inputs":{"operator_version":"'"${{ needs.release-setup.outputs.version }}"'"}}'


  upload-bundle-operatorhub:
    if: ${{ inputs.action == 'upload bundle for operatorhub OLM catalog' || inputs.action == 'all' }}
    runs-on: ubuntu-22.04
    needs: release-setup
    steps:
    - uses: actions/checkout@v3
      with:
        path: vertica-kubernetes

    - name: Upload the OPM bundle to fork of k8s-operatorhub/community-operators
      uses: ./vertica-kubernetes/.github/actions/upload-opm-bundle
      with:
        token: ${{ secrets.PAT_TOKEN }}
        version: ${{ needs.release-setup.outputs.version }}
        upstreamRepo: k8s-operatorhub/community-operators
        forkRepo: spilchen/community-operators


  upload-bundle-openshift:
    if: ${{ inputs.action == 'upload bundle for openshift OLM catalog' || inputs.action == 'all' }}
    runs-on: ubuntu-22.04
    needs: release-setup
    steps:
    - uses: actions/checkout@v3
      with:
        path: vertica-kubernetes

    - name: Upload the OPM bundle to fork of k8s-operatorhub/community-operators
      uses: ./vertica-kubernetes/.github/actions/upload-opm-bundle
      with:
        token: ${{ secrets.PAT_TOKEN }}
        version: ${{ needs.release-setup.outputs.version }}
        upstreamRepo: redhat-openshift-ecosystem/community-operators-prod
        forkRepo: spilchen/community-operators-prod
